<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" sizes="32x32" href="#">
  <title>USER CONTENTS</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;400;700;900&family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <link rel="stylesheet" href="./css/styles2.css">
  <script src="https://kit.fontawesome.com/3d21c8498e.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="./dist/notifications.css">



</head>

<body>
    <div class="container" style="padding: 0;">
        <div class="top-content p-2 mb-2 bg-success text-white" style="border-radius: 5px 5px 0 0; font-size: 1rem;">
            MY CONTENTS
        </div>
        
        <section id="mid-content">
            
            <div class="row" id="vridge-items" style="width: 100%;">
                <!-- <div class="col-6">
                    <a href="#" type="button" class="btn btn-outline-success ema">
                        <img src="./images/vegetables-15442.png" alt="veges">
                        <p>VEGETABLES</p>
                    </a>
                </div>
                <div class="col-6">
                    <a href="#" type="button" class="btn btn-outline-success ema">
                        <img src="./images/banana-12918.png" alt="Fruits">
                        <p>FRUITS</p>
                    </a>
                </div>
    
                <div class="col-6">
                    <a href="#" type="button" class="btn btn-outline-success ema">
                        <img src="./images/crab-34551.png" alt="SEAFOOD" style="padding-top: 30px; padding-bottom: 12px;">
                        <p>SEAFOOD</p>
                    </a>
                </div>
                <div class="col-6">
                    <a href="#" type="button" class="btn btn-outline-success ema">
                       <img src="./images/milk-13974.png" alt="Dairy"> 
                       <p>DAIRY</p>
                    </a>
                </div>
                
                <div class="col-6">
                    <a href="#" type="button" class="btn btn-outline-success ema">
                        <img src="./images/bread-18153.png" alt="Baking and grains img">
                        <p>BAKINGS</p>
                    </a>
                </div>
                <div class="col-6">
                    <a href="#" type="button" class="btn btn-outline-success ema">
                        <img src="./images/meat-23505.png" alt="Poultry">
                        <p>POULTRY</p>
                    </a>
                </div>
            
                <div class="col-6">
                    <a href="#" type="button" class="btn btn-outline-success ema">
                        <img src="./images/food-13629.png" alt="food">
                        <p>MEALS</p>
                    </a>
                </div>
                <div class="col-6">
                    <a href="#" type="button" class="btn btn-outline-success ema">
                        <i class="fa-solid fa-network-wired" style="font-size:xx-large; padding:20px 0 10px;"></i>
                        <p>OTHERS</p>
                    </a>
                </div> -->
            </div>

            

        </section>
        <div class="bottom bg-success" style="border-radius: 0 0 5px 5px; margin:8px 0 0;">
            <nav class="navbar navbar-expand-sm nav-fill">
                <a class="nav-item nav-link " href="./content.html"><i class="fa-solid fa-house-chimney"></i></a>
                <a class="nav-item nav-link " href="#"><i class="fa-solid fa-magnifying-glass"></i></a>
                <a class="nav-item nav-link" data-toggle="modal" data-target="#add-new-item" href="#"><i class="fa-solid fa-circle-plus"></i></a>
                <a class="nav-item nav-link" href="./user-profile.html"><i class="fa-solid fa-user"></i></a>
            </nav>
            
            <!--  -->
        </div>
    </div>
  
  <div class="modal fade" id="add-new-item" tabindex="-1" role="dialog" aria-labelledby="add-new-item" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="modal-long-title">Add New Content</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
                <form action="" method="post" id="create-vridge-item" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="content-cart">Cartegory</label>
                        <select class="form-control form-control-lg" id="content-cart" name="type"required>
                            <option value="">Choose cart</option>
                            <option value="VEGETABLES">VEGETABLES</option>
                            <option value="FRUITS">FRUITS</option>
                            <option value="SEAFOOD">SEAFOOD</option>
                            <option value="DAIRY">DAIRY</option>
                            <option value="BAKING">BAKING</option>
                            <option value="POULRTY">POULRTY</option>
                            <option value="MEALS">MEALS</option>
                            <option value="OTHERS">OTHERS</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="item-name">Item Name</label>
                        <input type="text" class="form-control" placeholder="Item Name"  name="name" required>
                    </div>
                    
                    </div>
                    <div class="form-group">
                        <label for="date">Expiry date</label>
                        <input type="date" class="form-control" placeholder="expiry date" name="expireDate" required>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">Close</button>
                        <button type="submit"  id='save' class="btn btn-success btn-sm">Save</button>
                        <button type="submit"  id='saveWithImage' class="btn btn-success btn-sm">Upload Image and Save</button>

                    </div>
                </form>
            </div>
            
          </div>
        </div>
      </div>
  

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script src="./dist/notifications.js"></script>
    <script src='https://cdn.jsdelivr.net/jquery.cloudinary/1.0.18/jquery.cloudinary.js' type='text/javascript'></script>
    <script src="//widget.cloudinary.com/global/all.js" type="text/javascript"></script>
   
  <script>
         window.addEventListener('DOMContentLoaded', (event) => {
            function processImage(id) {
                var options = {
                    client_hints: true,
                };
                const imageurl = $.cloudinary.url(id, options);
                console.log(imageurl)
                return imageurl ;
            }

            function validateItemData(formData){
                const errorNotification = window.createNotification({theme: 'error'});
                if(!formData.has('type') || !formData.get('type') || formData.get('type') == '' ){
                  return  errorNotification({message: "please pick the item type"})
                
                }
                if(!formData.has('name') ||formData.get('name') == '' ){ 
                     return errorNotification({message: "Name is required"}) 
                    
                }
                if(!formData.has('expireDate') || !formData.get('expireDate')){
                   return errorNotification({message: "expiration is not filled"})
                   
                }
               
                return true;

            }
            const vridgeItems = document.getElementById('vridge-items');
            const errorNotification = window.createNotification({theme: 'error'});
            const successMessage = window.createNotification({theme:'success'});
            const infoNotification = window.createNotification({theme:'info'});
            const login = sessionStorage.getItem('vridge-login');
            if(login != 'yes') window.location.replace('./login.html');
            const username = sessionStorage.getItem('vridge-username');
            const allUsers = JSON.parse(localStorage.getItem('vridge-users'));
            const userID = allUsers.findIndex(user => user.username == username);
            var currentUser = allUsers[userID];
            var userVridgeItems = currentUser['vridge-items'];

            const addItemForm  = document.getElementById('create-vridge-item');
            // console.log(addItemForm)
            if(addItemForm){
                $(function() {
                    // var cl = new cloudinary.Cloudinary({cloud_name: "dnxgzw4rn", secure: true});
                    
                    $.cloudinary.config({cloud_name: "dnxgzw4rn",
                        api_key: '121245918516168', 
                        api_secret: '_Cmms3ZKtSmFB3hzGgACuxwumSo' ,secure: true});
                    // Upload button
                    var uploadButton = $('#saveWithImage');
                    var submitWithoutUpload =  $('#save');
                    submitWithoutUpload.on('click', function(e){
                        e.preventDefault();

                        const formData = new FormData(addItemForm);
                        const validated =validateItemData(formData)
                        if(!validated){
                            return
                        }
                        const newItem = {};
                        for(const pair of formData.entries()) {
                            newItem[pair[0]] = pair[1]
                        }
                        newItem['itemImage'] = "./images/bread-18153.png";
                        console.log(newItem)
                       currentUser['vridge-items'] = [ ...userVridgeItems , newItem]
                       console.log(currentUser)
                       allUsers[userID] = currentUser;
                       localStorage.setItem('vridge-users',JSON.stringify(allUsers))
                       window.location.reload()



                    })
                    // Upload-button event
                    uploadButton.on('click', function(e){
                        e.preventDefault()
                        const formData = new FormData(addItemForm); 
                        const validated =validateItemData(formData)
                        if(validated !== true){
                            return validated;
                        }
                    
                        cloudinary.openUploadWidget({ cloud_name: 'dnxgzw4rn', upload_preset: 'ml_default', tags: ['cgal']}, 
                            function(error, result) { 
                                if(error) console.log(error);
                                // If NO error, log image data to console
                                var id = result[0].public_id;
                                const imageInfo = processImage(id)
                                const dateAdded = new Date().getDate();
                            

                                const newItem = {};
                                for(const pair of formData.entries()) {
                                    newItem[pair[0]] = pair[1]
                                }
                                newItem['itemImage'] = imageInfo
                                console.log(newItem)
                                currentUser['vridge-items'] = [ ...userVridgeItems , newItem]
                                console.log(currentUser)
                                allUsers[userID] = currentUser;
                                localStorage.setItem('vridge-users',JSON.stringify(allUsers))
                                window.location.reload()

                            });
                        });
                    });

            }
            
                   

                
            


            if(userVridgeItems.length < 1)
            {
                infoNotification({message:`Dear ${currentUser['firstName']}, Your fridge is empty`})
                vridgeItems.innerHTML  = ` <div class="col-6">
                    <a href="#" type="button" class="btn btn-outline-success ema">
                        <img src="./images/bread-18153.png" alt="Baking and grains img">
                        <p>Empty</p>
                    </a>
                </div>`
            }
            else
            {
                let fridgeContent = '';

                userVridgeItems.forEach(item => {
                    fridgeContent +=` <div class="col-6">
                    <a href="#" type="button" class="btn btn-outline-success ema">
                        <img src="${item.itemImage ?? './images/bread-18153.png'} " alt="${item.name} image">
                        <p>${item.name}</p>
                    </a>
                </div>`  
                });

                vridgeItems.innerHTML = fridgeContent
    
            }
         })
    </script>
</body>

</html>
